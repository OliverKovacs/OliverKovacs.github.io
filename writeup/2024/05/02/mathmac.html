<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>MathMAC | Oliver Kovacs</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="MathMAC" />
<meta name="author" content="Oliver Kovacs" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="openECSC 2024 - Round 2" />
<meta property="og:description" content="openECSC 2024 - Round 2" />
<link rel="canonical" href="https://oliverkovacs.dev/writeup/2024/05/02/mathmac.html" />
<meta property="og:url" content="https://oliverkovacs.dev/writeup/2024/05/02/mathmac.html" />
<meta property="og:site_name" content="Oliver Kovacs" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-02T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="MathMAC" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Oliver Kovacs"},"dateModified":"2024-05-02T00:00:00+02:00","datePublished":"2024-05-02T00:00:00+02:00","description":"openECSC 2024 - Round 2","headline":"MathMAC","mainEntityOfPage":{"@type":"WebPage","@id":"https://oliverkovacs.dev/writeup/2024/05/02/mathmac.html"},"url":"https://oliverkovacs.dev/writeup/2024/05/02/mathmac.html"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="https://oliverkovacs.dev/feed.xml" title="Oliver Kovacs" /><link rel="icon" type="image/x-icon" href="/assets/img/favicon.png">

    <!-- is a post -->
    
        <link rel="stylesheet" href="/assets/css/post.css">

        <!-- KaTeX -->
        <link rel="stylesheet" href="/assets/lib/katex/katex.min.css" integrity="sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww">
        <script defer src="/assets/lib/katex/katex.min.js" integrity="sha384-hIoBPJpTUs74ddyc4bFZSM1TVlQDA60VBbJS0oA934VSz82sBx1X7kSx2ATBDIyd"></script>
        <script defer src="/assets/lib/katex/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" onload="renderMathInElement(document.body);"></script>
    
</head>
<body>
    <a id="skip" href="#main"><h2>Skip to main content</h2></a>

    <div id="overlay"><header>
    
    <h1 class="post-title p-name" itemprop="name headline">MathMAC</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-05-02T00:00:00+02:00" itemprop="datePublished">2024 May 2
      </time><a href="/">
        <span itemprop="author" itemscope itemtype="http:/*schema.org/Person">
            <span class="p-author h-card" itemprop="name">Oliver Kovacs</span>
        </span>
      </a></p>
    
</header>
<main id="main" class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http:/*schema.org/BlogPosting">
  <div class="post-content e-content" itemprop="articleBody">
    <p><strong>openECSC 2024 - Round 2</strong></p>

<p>Category: <code class="language-plaintext highlighter-rouge">crypto</code></p>
<h2 id="description">
  
  
    Description <a href="#description">#</a>
  
  
</h2>
    

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Why using boring symmetric crypto for MACs when we can use fancy math?
</code></pre></div></div>

<p>Attachments: <code class="language-plaintext highlighter-rouge">mathmac.py</code> (see <a href="#appendix">Appendix</a>)</p>
<h2 id="probem">
  
  
    Probem <a href="#probem">#</a>
  
  
</h2>
    

<p>Let \(p = 8636821143825786083\) and \(M = 64\).<br />
Let \(\bold k = k_0, \ldots,k_M\) where \(k_i \in \mathbb Z_{\lt p}\) be a private key chosen at random.<br />
Let \(\bold x  \in \{0, 1\}^M\) with \(\bold x = x_1, \ldots, x_M\) be an \(M\)-bit binary word.<br />
Let \(h \colon \{0, 1\}^M \to \mathbb Z_p\) be a hash function defined as</p>

\[h(\bold x) = 4^{k_0 + x_1 k_1+ \cdots x_M k_M} \mod p \ .\]

<p>The challenge is:</p>

<ul>
  <li>The attacker can request an unlimited amount of word/hash pairs \((\bold x, h(\bold x))\) chosen at random.</li>
  <li>Then the attacker has to submit a word/hash pair \((\bold x ^\prime, h(\bold x ^\prime))\) that has not yet been revealed.
    <ul>
      <li>If the submission is correct the attacker obtains the flag.</li>
      <li>Only a single submission can be made.</li>
    </ul>
  </li>
</ul>
<h2 id="solution">
  
  
    Solution <a href="#solution">#</a>
  
  
</h2>
    

<p>The first step involves solving the <a href="https://en.wikipedia.org/wiki/Discrete_logarithm">discrete logarithm problem (DLP)</a>.</p>
<h3 id="dlp">
  
  
    DLP <a href="#dlp">#</a>
  
  
</h3>
    

<p>Let \(h(\bold x)\) be an element of the cyclic subgroup \(\langle 4 \rangle\) of \(\mathbb Z_p^*\).<br />
If \(4^n \equiv h(\bold x) \mod p\) then \(n\) is the discrete logarithm of \(h(\bold x)\) to the base \(4\) denoted as \(n = \log_4(h(\bold x))\).<br />
Solving this is useful because \(n\) is directly related to \(k_0 + x_1 k_1 + \cdots x_M k_M\).</p>

<p>Some notes:</p>
<ul>
  <li>\(\lvert \mathbb Z_p^*\rvert = p - 1\).</li>
  <li>From <a href="https://en.wikipedia.org/wiki/Lagrange%27s_theorem_(group_theory)">Lagrange’s theorem</a> it follows that \(\lvert4\rvert\) divides \(\lvert \mathbb Z_p^*\rvert\)
    <ul>
      <li>This means that  \(|4|\) is \(1\), \(2\), \(4318410571912893041\) or \(8636821143825786082\).<br />
  It’s easy to see that in practice only the last two are possible.</li>
    </ul>
  </li>
  <li>The DLP is easy to solve if the order of the group is <a href="https://en.wikipedia.org/wiki/Smooth_number">smooth</a> using the <a href="https://en.wikipedia.org/wiki/Pohlig%E2%80%93Hellman_algorithm">Pohlig-Hellman algorithm</a>.
    <ul>
      <li>This is not the case because \(p = 8636821143825786083 = 2 \cdot 4318410571912893041 + 1\) is a safe prime.</li>
    </ul>
  </li>
  <li>The base 4 doesn’t matter. Computing a logarithm to any base \(x\) is sufficient, because</li>
</ul>

\[\log_ba = \log_x a \cdot (\log_xb)^{-1} \ .\]

<p>The fastest known algorithm to compute the DLP in this case is a number field sieve.<br />
One implementation is <a href="https://cado-nfs.gitlabpages.inria.fr/">CADO-NFS</a>.</p>
<h3 id="cado-nfs">
  
  
    CADO-NFS <a href="#cado-nfs">#</a>
  
  
</h3>
    
<p>Setup:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://gitlab.inria.fr/cado-nfs/cado-nfs
<span class="nb">cd </span>cado-nfs
make
<span class="c"># create paramter files for 19 bit</span>
<span class="nb">cp </span>parameters/dlp/params.p30 parameters/dlp/params.p19
<span class="nb">cp </span>parameters/dlp/p30.hint parameters/dlp/p19.hint
</code></pre></div></div>
<p>Example: Compute the DLP of <code class="language-plaintext highlighter-rouge">4802397593893189429</code>:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ell is the order of ⟨4⟩</span>
./cado-nfs.py <span class="nt">--dlp</span> <span class="se">\</span>
    <span class="nt">--ell</span> 4318410571912893041 <span class="se">\</span>
    <span class="nv">target</span><span class="o">=</span>4802397593893189429 <span class="se">\</span>
    8636821143825786083
<span class="c"># 2192507630663880847</span>

./cado-nfs.py <span class="nt">--dlp</span> <span class="se">\</span>
    <span class="nt">--ell</span> 4318410571912893041 <span class="se">\</span>
    <span class="nv">target</span><span class="o">=</span>4 <span class="se">\</span>
    8636821143825786083
<span class="c"># 941720563644317575</span>
</code></pre></div></div>

<p>Thus \(\log_4 4802397593893189429 = 2192507630663880847 \cdot 941720563644317575^{-1}\)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># python
</span><span class="n">p</span> <span class="o">=</span> <span class="mi">8636821143825786083</span>
<span class="n">ell</span> <span class="o">=</span> <span class="mi">4318410571912893041</span>
<span class="n">result</span> <span class="o">=</span> <span class="mi">2192507630663880847</span> <span class="o">*</span> <span class="nf">pow</span><span class="p">(</span><span class="mi">941720563644317575</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ell</span><span class="p">)</span> <span class="c1"># 1234567890
</span>
<span class="c1"># double check the result
</span><span class="nf">pow</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>   <span class="c1"># 4802397593893189429 → correct
</span></code></pre></div></div>
<h3 id="attack">
  
  
    Attack <a href="#attack">#</a>
  
  
</h3>
    

<p>Now we need the hashes of three words \(\bold a, \bold b, \bold c\) such that \(\bold a + \bold b - \bold c\) doesn’t under- or overflow any of the individual bits.<br />
Then we can compute the hash of \(\bold z = \bold a + \bold b - \bold c\) as follows:</p>

\[h(\bold z) = 4^{\log_4(h(\bold a)) + \log_4(h(\bold b)) + (\log_4(h(\bold c)))^{-1}} \mod p\]

<p>Note that we need two positive and one negative term so that the secret \(k_0\) contained in every hash occurs exactly once.</p>
<h3 id="conclusion">
  
  
    Conclusion <a href="#conclusion">#</a>
  
  
</h3>
    

<p>A high level overview of the exploit is:</p>
<ul>
  <li>Generate around 1000 (word, hash) pairs.</li>
  <li>Do a bruteforce search to find 3 suitable words \(\bold a, \bold b, \bold c\).</li>
  <li>Compute the discrete logarithm of the hashes using CADO-NFS.</li>
  <li>Forge the hash of \(\bold z = \bold a + \bold b - \bold c\) as explained.</li>
  <li>Submit \((\bold z, h(\bold z))\).</li>
  <li>Profit.</li>
</ul>

<p>A reference implementation can be found in the <a href="#appendix">Appendix</a>.</p>
<h2 id="appendix">
  
  
    Appendix <a href="#appendix">#</a>
  
  
</h2>
    

<p><code class="language-plaintext highlighter-rouge">solve.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># this program expects an input file data.txt
# each line should contain a 'value,hash(value)' pair
# around 1000 pairs seem to be ideal
# this program outputs a value,hash(value) pair to submit
</span>
<span class="kn">import</span> <span class="n">subprocess</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">random</span> <span class="kn">import</span> <span class="n">randint</span>

<span class="n">p</span> <span class="o">=</span> <span class="mi">8636821143825786083</span>
<span class="n">q</span> <span class="o">=</span> <span class="mi">4318410571912893041</span>
<span class="n">g</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">M</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">MAX</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">M</span> <span class="o">-</span> <span class="mi">1</span>

<span class="c1"># change as needed
</span><span class="n">CADO_PATH</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/home/user/opt/cado-nfs</span><span class="sh">"</span>
<span class="n">CADO</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">CADO_PATH</span><span class="p">,</span> <span class="sh">'</span><span class="s">cado-nfs.py</span><span class="sh">'</span><span class="p">))</span>

<span class="c1"># given the multiplicative group of integers mod p (ℤ/pℤ)^*
# and the subgroup H generated by g where |g| = q and h ∈ H
# find x such that g^x ≡ h (mod p)  
</span><span class="k">def</span> <span class="nf">dlp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="n">log_h</span> <span class="o">=</span> <span class="nf">cado_nfs</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">log_g</span> <span class="o">=</span> <span class="nf">cado_nfs</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">log_g_inv</span> <span class="o">=</span> <span class="nf">pow</span><span class="p">(</span><span class="n">log_g</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">log_h</span> <span class="o">*</span> <span class="n">log_g_inv</span> <span class="o">%</span> <span class="n">q</span>
    <span class="k">return</span> <span class="n">log</span>

<span class="c1"># precompute log 4
</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">941720563644317575</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">cado_nfs</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="n">cached</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">cached</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span> <span class="k">return</span> <span class="n">cached</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">CADO</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">--dlp</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">--ell</span><span class="sh">'</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">o</span><span class="p">),</span>
        <span class="sh">'</span><span class="s">target=</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
        <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nc">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
        <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">readline</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">ascii</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cache</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span> <span class="n">t</span><span class="p">:</span> <span class="n">out</span> <span class="p">})</span>
    <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="c1"># brute-froce search
</span><span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">e1</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
            <span class="n">e2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span>
            <span class="n">AND</span> <span class="o">=</span> <span class="n">e1</span> <span class="o">&amp;</span> <span class="n">e2</span>
            <span class="n">NOR</span> <span class="o">=</span> <span class="n">MAX</span> <span class="o">^</span> <span class="p">(</span><span class="n">e1</span> <span class="o">|</span> <span class="n">e2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i3</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="nf">if </span><span class="p">(</span><span class="n">i3</span> <span class="o">==</span> <span class="n">i1</span> <span class="ow">or</span> <span class="n">i3</span> <span class="o">==</span> <span class="n">i2</span><span class="p">):</span> <span class="k">continue</span>
                <span class="n">e3</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i3</span><span class="p">]</span>
                <span class="n">INV</span> <span class="o">=</span> <span class="n">MAX</span> <span class="o">^</span> <span class="n">e3</span>
                <span class="nf">if </span><span class="p">(</span><span class="n">AND</span> <span class="o">&amp;</span> <span class="n">e3</span> <span class="o">==</span> <span class="n">AND</span> <span class="ow">and</span> <span class="n">NOR</span> <span class="o">&amp;</span> <span class="n">INV</span> <span class="o">==</span> <span class="n">NOR</span><span class="p">):</span>
                    <span class="nf">return </span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">failed</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">p =</span><span class="sh">"</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">q =</span><span class="sh">"</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">g =</span><span class="sh">"</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s"># searching for a, b, c...</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span> <span class="o">=</span> <span class="nf">search</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">array</span><span class="p">)))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">i1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">array</span><span class="p">[</span><span class="n">i2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">array</span><span class="p">[</span><span class="n">i3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">a =</span><span class="sh">"</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="n">i1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">b =</span><span class="sh">"</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="n">i2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">c =</span><span class="sh">"</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="n">i3</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">x =</span><span class="sh">"</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">hash_a =</span><span class="sh">"</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="n">i1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">hash_b =</span><span class="sh">"</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="n">i2</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">hash_c =</span><span class="sh">"</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="n">i3</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s"># solving dlp...</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="n">log_a</span> <span class="o">=</span> <span class="nf">dlp</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">g</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">log_b</span> <span class="o">=</span> <span class="nf">dlp</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">g</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">log_c</span> <span class="o">=</span> <span class="nf">dlp</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i3</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">g</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">log_c_inv</span> <span class="o">=</span> <span class="nf">pow</span><span class="p">(</span><span class="n">log_c</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">log_x</span> <span class="o">=</span> <span class="n">log_a</span> <span class="o">*</span> <span class="n">log_b</span> <span class="o">*</span> <span class="n">log_c_inv</span> <span class="o">%</span> <span class="n">q</span>
    <span class="n">hash_x</span> <span class="o">=</span> <span class="nf">pow</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">log_x</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">log_a =</span><span class="sh">"</span><span class="p">,</span> <span class="n">log_a</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">log_b =</span><span class="sh">"</span><span class="p">,</span> <span class="n">log_b</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">log_c =</span><span class="sh">"</span><span class="p">,</span> <span class="n">log_c</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">log_x =</span><span class="sh">"</span><span class="p">,</span> <span class="n">log_x</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">hash_x =</span><span class="sh">"</span><span class="p">,</span> <span class="n">hash_x</span><span class="p">)</span>

    <span class="nf">return </span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hash_x</span><span class="p">)</span>

<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">data.txt</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">txt</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="nf">list</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="p">))),</span> <span class="n">lines</span><span class="p">))</span>

<span class="n">x</span><span class="p">,</span> <span class="n">log_x</span> <span class="o">=</span> <span class="nf">solve</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="sh">'</span><span class="s">,</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">log_x</span><span class="p">))</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">mathmac.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="n">flag</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">'</span><span class="s">FLAG</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">flag{redacted}</span><span class="sh">'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MAC</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="mi">8636821143825786083</span>
        <span class="n">self</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sk</span> <span class="o">=</span> <span class="p">[</span><span class="nf">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="nf">pow</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nf">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">p</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">p</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">**</span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nf">bin</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">2</span><span class="p">:].</span><span class="nf">zfill</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">n</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">n</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">base</span>
        <span class="k">for</span> <span class="n">ai</span><span class="p">,</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">sk</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">xi</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nf">pow</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">ai</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">menu</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">1. Generate token</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">2. Validate token</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">3. Quit</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Welcome to the magic MathMAC. Can you become a wizard and guess tokens?</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="n">mac</span> <span class="o">=</span> <span class="nc">MAC</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="nf">menu</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nf">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="n">M</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">mac</span><span class="p">.</span><span class="nf">sign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s">,</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="nf">input</span><span class="p">().</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">actual_tag</span> <span class="o">=</span> <span class="n">mac</span><span class="p">.</span><span class="nf">sign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">actual_tag</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">actual_tag</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Unlucky</span><span class="sh">"</span><span class="p">)</span>
                <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Yup. I know.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

  </div><a class="u-url" href="/writeup/2024/05/02/mathmac.html" hidden></a>
</article>

      </div>
    </main></div>

  </body>

</html>
